<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Система уведомлений</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        #status { text-align: center; margin-bottom: 20px; font-weight: bold; color: #dc3545; }

        /* Стили уведомлений */
        .notification { padding: 15px; margin-bottom: 10px; border-left: 5px solid; border-radius: 4px; animation: slideIn 0.5s ease-out; }
        .verdict-TOP_DEVICE { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .verdict-AVERAGE { background-color: #fff3cd; border-color: #ffc107; color: #856404; }
        .verdict-BAD { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
<div class="container">
    <h2>Центр уведомлений (Devices)</h2>
    <div id="status">Отключено</div>
    <div id="notifications-area"></div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const area = document.getElementById('notifications-area');
    let socket;
    let pingInterval;

    function connect() {
        // Подключаемся к порту 8083
        socket = new WebSocket('ws://localhost:8083/ws/notifications');

        socket.onopen = () => {
            statusDiv.innerText = 'Подключено к системе событий';
            statusDiv.style.color = '#28a745';
            // ЗАПУСКАЕМ ПИНГЕР
            startPing();
        };

        socket.onmessage = (event) => {
            // 1. Проверяем, не техническое ли это сообщение
            if (event.data === "PONG") {
                console.log("Server: PONG (Connection alive)");
                return; // Не пытаемся парсить JSON
            }

            // 2. Обрабатываем полезную нагрузку
            try {
                const data = JSON.parse(event.data);
                console.log("Получено событие:", data);

                if (data.type === 'RATING_UPDATE') {
                    showNotification(data);
                }
            } catch (e) {
                console.error("Ошибка парсинга JSON:", event.data);
                // Если пришло просто текстовое сообщение (например, через broadcast ручной)
                if (typeof event.data === "string") {
                    showSimpleMessage(event.data);
                }
            }
        };

        socket.onclose = () => {
            statusDiv.innerText = 'Соединение разорвано. Переподключение...';
            statusDiv.style.color = '#dc3545';
            stopPing(); // Останавливаем пингер
            setTimeout(connect, 3000);
        };
    }

    // --- Логика Ping/Pong ---
    function startPing() {
        // Каждые 10 секунд шлем PING
        pingInterval = setInterval(() => {
            if (socket.readyState === WebSocket.OPEN) {
                console.log("Client: PING");
                socket.send("PING");
            }
        }, 10000);
    }

    function stopPing() {
        if (pingInterval) clearInterval(pingInterval);
    }
    // ------------------------

    function showNotification(data) {
        const div = document.createElement('div');
        // Защита от пробелов в классе
        const cssClass = data.verdict ? data.verdict.replace(' ', '_') : 'AVERAGE';
        div.className = `notification verdict-${cssClass}`;

        div.innerHTML = `
            <strong>Устройство ID: ${data.userId}</strong><br>
            Рейтинг рассчитан: <b>${data.score}</b><br>
            Вердикт: ${data.verdict}
        `;
        area.prepend(div);
    }

    // На случай ручных тестов через Postman (plain text)
    function showSimpleMessage(msg) {
        const div = document.createElement('div');
        div.className = `notification verdict-AVERAGE`;
        div.innerHTML = `<b>Сообщение администратора:</b><br>${msg}`;
        area.prepend(div);
    }

    connect();
</script>
</body>
</html>